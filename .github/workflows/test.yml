name: Tests

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]
  workflow_dispatch:
    inputs:
      test_suite:
        description: 'Which test suite to run'
        required: false
        default: 'all'
        type: choice
        options:
          - all
          - security
          - integration
          - commands
      os:
        description: 'Operating system'
        required: false
        default: 'ubuntu-latest'
        type: choice
        options:
          - ubuntu-latest
          - macos-latest
          - both

jobs:
  test-ubuntu:
    name: Test Suite (Ubuntu)
    runs-on: ubuntu-latest
    if: |
      github.event_name != 'workflow_dispatch' ||
      inputs.os == 'both' ||
      inputs.os == 'ubuntu-latest'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build Go binary
        run: make build

      - name: Run Go unit tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload Go coverage
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage-ubuntu
          path: coverage.out

      - name: Configure git for tests
        run: |
          git config --global user.name "CI Test"
          git config --global user.email "ci@dotclaude.test"

      # Note: BATS tests are legacy and test the archived shell implementation.
      # The Go implementation is now the primary codebase. Go unit tests above
      # cover the functionality that was previously tested by BATS.
      # See tests/README.md for details on the test migration.

      - name: Test results summary
        if: always()
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- OS: ubuntu-latest" >> $GITHUB_STEP_SUMMARY
          echo "- Test Suite: ${{ github.event_name == 'workflow_dispatch' && inputs.test_suite || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  test-macos:
    name: Test Suite (macOS)
    runs-on: macos-latest
    if: |
      github.event_name != 'workflow_dispatch' ||
      inputs.os == 'both' ||
      inputs.os == 'macos-latest'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build Go binary
        run: make build

      - name: Run Go unit tests
        run: go test -v -race -coverprofile=coverage.out ./...

      - name: Upload Go coverage
        uses: actions/upload-artifact@v4
        with:
          name: go-coverage-macos
          path: coverage.out

      - name: Configure git for tests
        run: |
          git config --global user.name "CI Test"
          git config --global user.email "ci@dotclaude.test"

      # Note: BATS tests are legacy and test the archived shell implementation.
      # The Go implementation is now the primary codebase. Go unit tests above
      # cover the functionality that was previously tested by BATS.
      # See tests/README.md for details on the test migration.

      - name: Test results summary
        if: always()
        run: |
          echo "## Test Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- OS: macos-latest" >> $GITHUB_STEP_SUMMARY
          echo "- Test Suite: ${{ github.event_name == 'workflow_dispatch' && inputs.test_suite || 'all' }}" >> $GITHUB_STEP_SUMMARY
          echo "- Trigger: ${{ github.event_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ job.status }}" >> $GITHUB_STEP_SUMMARY

  lint:
    name: Go & Shell Linting
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Run go vet
        run: go vet ./...

      - name: Check go fmt
        run: |
          if [ -n "$(gofmt -l .)" ]; then
            echo "Go files need formatting:"
            gofmt -l .
            exit 1
          fi

      - name: Install shellcheck
        run: sudo apt-get update && sudo apt-get install -y shellcheck

      - name: Run shellcheck on install script
        run: shellcheck -e SC1091,SC2162,SC2086 install.sh

      - name: Run shellcheck on test helpers
        run: |
          find tests -name "*.bash" | while read -r file; do
            echo "Checking $file"
            # Exclude SC1091 (sourced files), SC2154 (bats built-in variables like $output)
            shellcheck -e SC1091,SC2154 "$file" || exit 1
          done

  test-install:
    name: Test Installation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Build Go binary
        run: make build

      - name: Run Go unit tests
        run: go test -v ./...

      - name: Configure git for tests
        run: |
          git config --global user.name "CI Test"
          git config --global user.email "ci@dotclaude.test"

      - name: Test install script (non-interactive)
        run: ./install.sh --non-interactive
        env:
          DOTCLAUDE_REPO_DIR: ${{ github.workspace }}

      - name: Verify dotclaude command available
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export DOTCLAUDE_REPO_DIR="${{ github.workspace }}"
          dotclaude version
          dotclaude help

      - name: Test profile creation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export DOTCLAUDE_REPO_DIR="${{ github.workspace }}"
          # Create profiles directory and copy example
          mkdir -p ${{ github.workspace }}/profiles
          cp -r ${{ github.workspace }}/examples/sample-profile ${{ github.workspace }}/profiles/ci-test
          dotclaude create ci-test-2
          dotclaude list

      - name: Test profile activation
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          export DOTCLAUDE_REPO_DIR="${{ github.workspace }}"
          dotclaude activate ci-test
          dotclaude show
          test -f ~/.claude/CLAUDE.md
          grep -q "Global Claude Code Instructions" ~/.claude/CLAUDE.md

  coverage:
    name: Test Coverage Report
    runs-on: ubuntu-latest
    needs: [test-ubuntu, test-macos, lint, test-install]

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: '1.23'

      - name: Download Go coverage artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: go-coverage-*
          path: ./coverage
        continue-on-error: true

      - name: Count Go tests and coverage
        id: go_count
        run: |
          GO_TEST_COUNT=$(go test -v ./... 2>&1 | grep -c "^--- PASS\|^--- FAIL" || echo 0)
          GO_COVERAGE=$(go test -cover ./... 2>&1 | grep -oP 'coverage: \K[0-9.]+' | awk '{sum+=$1; count++} END {if(count>0) printf "%.1f", sum/count; else print "0"}')
          echo "go_tests=$GO_TEST_COUNT" >> $GITHUB_OUTPUT
          echo "go_coverage=$GO_COVERAGE" >> $GITHUB_OUTPUT

      - name: Generate coverage report
        run: |
          echo "## Test Coverage Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Go Unit Tests (Primary)" >> $GITHUB_STEP_SUMMARY
          echo "| Metric | Value |" >> $GITHUB_STEP_SUMMARY
          echo "|--------|-------|" >> $GITHUB_STEP_SUMMARY
          echo "| Go Tests | ${{ steps.go_count.outputs.go_tests }} |" >> $GITHUB_STEP_SUMMARY
          echo "| Coverage | ${{ steps.go_count.outputs.go_coverage }}% |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Test Packages" >> $GITHUB_STEP_SUMMARY
          echo "- \`internal/profile/\` - Profile management, validation, activation" >> $GITHUB_STEP_SUMMARY
          echo "- \`internal/cli/\` - Command handlers, flags, output" >> $GITHUB_STEP_SUMMARY
          echo "- \`internal/hooks/\` - Hook execution and management" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Legacy BATS Tests" >> $GITHUB_STEP_SUMMARY
          echo "BATS tests in \`tests/\` are legacy and test the archived shell implementation." >> $GITHUB_STEP_SUMMARY
          echo "The Go implementation now provides equivalent functionality with Go unit tests." >> $GITHUB_STEP_SUMMARY
