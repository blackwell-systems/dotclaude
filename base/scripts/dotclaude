#!/bin/bash

# dotclaude - The definitive profile management system for Claude Code
# Version: 1.0.0

set -e

VERSION="1.0.0"
CLAUDE_DIR="${CLAUDE_DIR:-$HOME/.claude}"
REPO_DIR="${DOTCLAUDE_REPO_DIR:-$HOME/code/dotclaude}"
BASE_DIR="$REPO_DIR/base"
PROFILES_DIR="$REPO_DIR/profiles"

# Debug mode (set DEBUG=1 or use --verbose flag)
DEBUG="${DEBUG:-0}"
DEBUG_LOG="$CLAUDE_DIR/.dotclaude-debug.log"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
CYAN='\033[0;36m'
BOLD='\033[1m'
NC='\033[0m'

# Debug function
debug() {
    if [ "$DEBUG" = "1" ]; then
        local timestamp
        timestamp=$(date '+%Y-%m-%d %H:%M:%S')
        echo -e "${CYAN}[DEBUG $timestamp]${NC} $*" >&2
        # Also log to file for troubleshooting
        echo "[$timestamp] $*" >> "$DEBUG_LOG" 2>/dev/null || true
    fi
}

# Load validation library
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
if [ -f "$SCRIPT_DIR/lib/validation.sh" ]; then
    source "$SCRIPT_DIR/lib/validation.sh"
else
    # Fallback inline validation if lib not found
    validate_profile_name() {
        if [[ ! "$1" =~ ^[a-zA-Z0-9_-]+$ ]]; then
            echo -e "${RED}Error: Invalid profile name: $1${NC}" >&2
            echo "  Profile names must contain only letters, numbers, hyphens, and underscores" >&2
            return 1
        fi
    }

    validate_repo_dir() {
        local repo_dir="$1"

        if [ -z "$repo_dir" ] || [ ! -d "$repo_dir" ]; then
            return 1
        fi

        # Only require base directory - profiles can be created as needed
        if [ ! -d "$repo_dir/base" ]; then
            return 1
        fi

        return 0
    }

    acquire_lock() {
        local lockfile="$1"
        local timeout="${2:-5}"

        # Create parent directory if it doesn't exist
        local lockdir
        lockdir="$(dirname "$lockfile")"
        if [ ! -d "$lockdir" ]; then
            mkdir -p "$lockdir" || return 1
        fi

        exec 200>"$lockfile"

        if ! flock -w "$timeout" 200 2>/dev/null; then
            echo -e "${YELLOW}Warning: Another dotclaude operation in progress${NC}" >&2
            echo "  Waiting for lock: $lockfile" >&2
            echo "  Timeout: ${timeout}s" >&2
            return 1
        fi

        return 0
    }

    release_lock() {
        exec 200>&-  # Close file descriptor
    }
fi

# Trap handler for cleanup
cleanup() {
    release_lock 2>/dev/null || true
}
trap cleanup EXIT ERR INT TERM

# Validate repository structure on startup (skip for commands that don't need repo)
SKIP_REPO_VALIDATION=false
case "${1:-}" in
    version|-v|--version|help|-h|--help)
        SKIP_REPO_VALIDATION=true
        ;;
esac

if [ "$SKIP_REPO_VALIDATION" = "false" ] && [ -d "$REPO_DIR" ] && ! validate_repo_dir "$REPO_DIR" 2>/dev/null; then
    echo -e "${RED}Error: Invalid dotclaude repository at: $REPO_DIR${NC}" >&2
    echo "  Set DOTCLAUDE_REPO_DIR environment variable to correct location" >&2
    exit 1
fi

# ============================================================================
# UI Components
# ============================================================================

header() {
    echo ""
    echo -e "${BOLD}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${BOLD}â”‚  ğŸŒ² dotclaude                                               â”‚${NC}"
    echo -e "${BOLD}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo ""
}

footer_tip() {
    local message="$1"
    echo ""
    echo "â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®"
    echo -e "â”‚  ğŸƒ Tip: ${message}$(printf ' %.0s' {1..100})" | cut -c1-61 | sed 's/$/â”‚/'
    echo "â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯"
    echo ""
}

success_box() {
    local message="$1"
    echo ""
    echo -e "${GREEN}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${GREEN}â”‚  âœ“ ${message}$(printf ' %.0s' {1..100})${NC}" | cut -c1-61 | sed "s/\$/â”‚/"
    echo -e "${GREEN}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo ""
}

error_box() {
    local message="$1"
    echo ""
    echo -e "${RED}â•­â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•®${NC}"
    echo -e "${RED}â”‚  âœ— ${message}$(printf ' %.0s' {1..100})${NC}" | cut -c1-61 | sed "s/\$/â”‚/"
    echo -e "${RED}â•°â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â•¯${NC}"
    echo ""
}

# ============================================================================
# Core Commands
# ============================================================================

cmd_show() {
    # Parse flags
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    debug "cmd_show called"
    header

    if [ ! -f "$CLAUDE_DIR/.current-profile" ]; then
        echo "  No profile currently active"
        echo ""
        footer_tip "Run 'dotclaude list' to see available profiles"
        return 0
    fi

    local profile
    profile=$(cat "$CLAUDE_DIR/.current-profile")
    echo -e "  ${BOLD}Active Profile:${NC} ${GREEN}$profile${NC}"
    echo ""

    echo "  Configuration:"
    if [ -f "$CLAUDE_DIR/CLAUDE.md" ]; then
        local lines
        lines=$(wc -l < "$CLAUDE_DIR/CLAUDE.md")
        echo "    â€¢ CLAUDE.md: $lines lines"
    fi
    if [ -f "$CLAUDE_DIR/settings.json" ]; then
        echo "    â€¢ settings.json: configured"
    fi

    echo ""
    echo "  Location:"
    echo "    â€¢ ~/.claude/"

    footer_tip "Run 'dotclaude switch' to change profiles"
}

cmd_list() {
    # Parse flags
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    debug "cmd_list called"
    debug "PROFILES_DIR: $PROFILES_DIR"
    header

    if [ ! -d "$PROFILES_DIR" ]; then
        error_box "Profiles directory not found at $PROFILES_DIR"
        echo "  Set DOTCLAUDE_REPO_DIR environment variable if repo is elsewhere"
        echo ""
        exit 1
    fi

    local current=""
    if [ -f "$CLAUDE_DIR/.current-profile" ]; then
        current=$(cat "$CLAUDE_DIR/.current-profile")
    fi

    echo "  Available Profiles:"
    echo ""

    local count=0
    for profile_dir in "$PROFILES_DIR"/*; do
        if [ -d "$profile_dir" ]; then
            local profile
            profile=$(basename "$profile_dir")
            if [ "$profile" = "$current" ]; then
                echo -e "    ${GREEN}â—${NC} ${BOLD}$profile${NC} ${GREEN}(active)${NC}"
            else
                echo "    â—‹ $profile"
            fi
            count=$((count + 1))
        fi
    done

    echo ""
    echo "  Total: $count profiles"

    footer_tip "Use 'dotclaude activate <name>' or 'dotclaude switch'"
}

cmd_activate() {
    local profile_name=""
    local dry_run=false

    # Parse arguments
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            --dry-run|--preview)
                dry_run=true
                shift
                ;;
            -*)
                error_box "Unknown flag: $1"
                echo "  Usage: dotclaude activate <profile-name> [--dry-run] [--verbose]"
                exit 1
                ;;
            *)
                profile_name="$1"
                shift
                ;;
        esac
    done

    debug "Starting cmd_activate"
    debug "Profile name: $profile_name"
    debug "Dry-run: $dry_run"
    debug "REPO_DIR: $REPO_DIR"
    debug "CLAUDE_DIR: $CLAUDE_DIR"

    if [ -z "$profile_name" ]; then
        error_box "Profile name required"
        echo "  Usage: dotclaude activate <profile-name> [--dry-run]"
        echo ""
        echo "  Available profiles:"
        for profile_dir in "$PROFILES_DIR"/*; do
            if [ -d "$profile_dir" ]; then
                echo "    â€¢ $(basename "$profile_dir")"
            fi
        done
        echo ""
        exit 1
    fi

    # Validate profile name (prevent path traversal)
    if ! validate_profile_name "$profile_name"; then
        exit 1
    fi

    local profile_dir="$PROFILES_DIR/$profile_name"

    if [ ! -d "$profile_dir" ]; then
        error_box "Profile '$profile_name' not found"
        echo "  Run 'dotclaude list' to see available profiles"
        echo ""
        exit 1
    fi

    # Check if we're re-activating the same profile
    local current_profile=""
    if [ -f "$CLAUDE_DIR/.current-profile" ]; then
        current_profile=$(cat "$CLAUDE_DIR/.current-profile")
    fi

    # DRY-RUN MODE
    if [ "$dry_run" = true ]; then
        header
        echo "  ${YELLOW}DRY-RUN MODE${NC} - Preview changes for: ${BOLD}$profile_name${NC}"
        echo ""

        echo "  ${BOLD}Changes that would be made:${NC}"
        echo ""

        # Show backup status
        if [ -f "$CLAUDE_DIR/CLAUDE.md" ] && [ "$current_profile" != "$profile_name" ]; then
            echo "    ${YELLOW}[BACKUP]${NC} Existing CLAUDE.md would be backed up"
        elif [ "$current_profile" = "$profile_name" ]; then
            echo "    ${BLUE}[UPDATE]${NC} Already on '$profile_name', would update in place"
        else
            echo "    ${BLUE}[NEW]${NC} No existing CLAUDE.md"
        fi

        # Show CLAUDE.md merge
        echo "    ${GREEN}[MERGE]${NC} CLAUDE.md: base + $profile_name"
        local base_lines
        base_lines=$(wc -l < "$BASE_DIR/CLAUDE.md")
        local profile_lines
        profile_lines=$(wc -l < "$profile_dir/CLAUDE.md")
        local total_lines=$((base_lines + profile_lines + 5))
        echo "            Base: $base_lines lines"
        echo "            Profile: $profile_lines lines"
        echo "            Result: ~$total_lines lines"

        # Show settings
        echo ""
        if [ -f "$profile_dir/settings.json" ]; then
            echo "    ${GREEN}[APPLY]${NC} settings.json: profile-specific"
            if [ -f "$CLAUDE_DIR/settings.json" ] && [ "$current_profile" != "$profile_name" ]; then
                echo "            ${YELLOW}[BACKUP]${NC} Existing settings.json would be backed up"
            fi
        else
            echo "    ${GREEN}[APPLY]${NC} settings.json: base"
        fi

        # Show profile marker
        echo ""
        echo "    ${GREEN}[SET]${NC} Active profile: $profile_name"

        echo ""
        echo "  ${BOLD}Files that would be modified:${NC}"
        echo "    â€¢ ~/.claude/CLAUDE.md"
        echo "    â€¢ ~/.claude/settings.json"
        echo "    â€¢ ~/.claude/.current-profile"
        if [ -f "$CLAUDE_DIR/CLAUDE.md" ] && [ "$current_profile" != "$profile_name" ]; then
            echo "    â€¢ ~/.claude/CLAUDE.md.backup.$(date +%Y%m%d-HHMMSS)"
        fi

        echo ""
        footer_tip "Run without --dry-run to apply changes"
        return 0
    fi

    # REAL ACTIVATION
    # Acquire lock to prevent concurrent activation
    if ! acquire_lock "$CLAUDE_DIR/.lock" 10; then
        error_box "Lock acquisition failed"
        exit 1
    fi

    header
    echo "  Activating profile: ${BOLD}$profile_name${NC}"
    echo ""

    # Backup existing CLAUDE.md if switching profiles
    if [ -f "$CLAUDE_DIR/CLAUDE.md" ] && [ "$current_profile" != "$profile_name" ]; then
        local backup
        backup="$CLAUDE_DIR/CLAUDE.md.backup.$(date +%Y%m%d-%H%M%S)"
        cp "$CLAUDE_DIR/CLAUDE.md" "$backup"
        chmod 600 "$backup" 2>/dev/null || true  # Secure permissions
        echo "  [1/3] Backed up existing CLAUDE.md"

        # Keep only 5 most recent backups
        find "$CLAUDE_DIR" -name "CLAUDE.md.backup.*" -type f -print0 2>/dev/null | sort -zr | tail -zn +6 | xargs -0 rm -f 2>/dev/null || true
    elif [ "$current_profile" = "$profile_name" ]; then
        echo "  [1/3] Already on '$profile_name', updating in place"
    else
        echo "  [1/3] No existing CLAUDE.md to backup"
    fi

    # Merge base + profile CLAUDE.md
    {
        cat "$BASE_DIR/CLAUDE.md"
        echo ""
        echo "# ========================================="
        echo "# Profile: $profile_name"
        echo "# ========================================="
        echo ""
        cat "$profile_dir/CLAUDE.md"
    } > "$CLAUDE_DIR/CLAUDE.md"
    echo "  [2/3] Merged base + profile configuration"

    # Apply settings
    if [ -f "$profile_dir/settings.json" ]; then
        # Only backup if switching profiles
        if [ -f "$CLAUDE_DIR/settings.json" ] && [ "$current_profile" != "$profile_name" ]; then
            local backup
            backup="$CLAUDE_DIR/settings.json.backup.$(date +%Y%m%d-%H%M%S)"
            cp "$CLAUDE_DIR/settings.json" "$backup"
            chmod 600 "$backup" 2>/dev/null || true  # Secure permissions

            # Keep only 5 most recent backups
            find "$CLAUDE_DIR" -name "settings.json.backup.*" -type f -print0 2>/dev/null | sort -zr | tail -zn +6 | xargs -0 rm -f 2>/dev/null || true
        fi
        cp "$profile_dir/settings.json" "$CLAUDE_DIR/settings.json"
        echo "  [3/3] Applied profile settings"
    else
        cp "$BASE_DIR/settings.json" "$CLAUDE_DIR/settings.json"
        echo "  [3/3] Applied base settings"
    fi

    # Mark as current
    echo "$profile_name" > "$CLAUDE_DIR/.current-profile"

    success_box "Profile '$profile_name' activated"

    echo "  Configuration deployed to: $CLAUDE_DIR"
    echo ""
    echo "  Verify with:"
    echo "    â€¢ dotclaude show"
    echo "    â€¢ cat ~/.claude/CLAUDE.md"

    footer_tip "Happy coding!"
}

cmd_switch() {
    # Parse flags
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    debug "cmd_switch called"
    debug "Current profile check: $CLAUDE_DIR/.current-profile"
    header

    echo "  Select a profile to activate:"
    echo ""

    local current=""
    if [ -f "$CLAUDE_DIR/.current-profile" ]; then
        current=$(cat "$CLAUDE_DIR/.current-profile")
        debug "Current profile: $current"
    fi

    local -a profiles=()
    local index=1

    for profile_dir in "$PROFILES_DIR"/*; do
        if [ -d "$profile_dir" ]; then
            local profile
            profile=$(basename "$profile_dir")
            if [ "$profile" = "$current" ]; then
                echo -e "    ${GREEN}[$index]${NC} ${BOLD}$profile${NC} ${GREEN}(active)${NC}"
            else
                echo "    [$index] $profile"
            fi
            profiles+=("$profile")
            index=$((index + 1))
        fi
    done

    echo ""
    read -r -p "  Enter number (or 'q' to quit): " choice

    if [ "$choice" = "q" ] || [ "$choice" = "Q" ]; then
        echo ""
        echo "  Cancelled"
        echo ""
        exit 0
    fi

    if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt "${#profiles[@]}" ]; then
        error_box "Invalid selection"
        exit 1
    fi

    local selected_profile="${profiles[$((choice - 1))]}"
    cmd_activate "$selected_profile"
}

cmd_create() {
    local profile_name=""

    # Parse arguments and flags
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            -*)
                error_box "Unknown flag: $1"
                echo "  Usage: dotclaude create <profile-name> [--verbose]"
                exit 1
                ;;
            *)
                profile_name="$1"
                shift
                ;;
        esac
    done

    debug "cmd_create called"
    debug "Profile name: $profile_name"

    if [ -z "$profile_name" ]; then
        error_box "Profile name required"
        echo "  Usage: dotclaude create <profile-name> [--verbose]"
        echo ""
        exit 1
    fi

    # Validate profile name (prevent path traversal and injection)
    if ! validate_profile_name "$profile_name"; then
        debug "Profile name validation failed"
        exit 1
    fi

    local profile_dir="$PROFILES_DIR/$profile_name"
    debug "Profile directory: $profile_dir"

    if [ -d "$profile_dir" ]; then
        error_box "Profile '$profile_name' already exists"
        debug "Profile already exists"
        exit 1
    fi

    header
    echo "  Creating new profile: ${BOLD}$profile_name${NC}"
    echo ""

    debug "Creating directory: $profile_dir"

    mkdir -p "$profile_dir"

    # Use single quotes to prevent variable expansion in heredoc
    cat > "$profile_dir/CLAUDE.md" <<'EOF'
# Profile: PROFILE_NAME_PLACEHOLDER

<!-- Profile-specific additions for PROFILE_NAME_PLACEHOLDER -->

**TODO: Add profile-specific content here**

This file will be merged with the base CLAUDE.md when this profile is active.

## Purpose

Define standards, practices, and guidelines specific to this context.

## Topics to Cover

- Context-specific coding standards
- Tech stack preferences
- Workflows and processes
- Documentation practices
- Security policies
- Deployment procedures
- Team collaboration practices
EOF

    # Safely replace placeholder with actual profile name (cross-platform sed)
    if [[ "$OSTYPE" == "darwin"* ]]; then
        sed -i '' "s/PROFILE_NAME_PLACEHOLDER/$profile_name/g" "$profile_dir/CLAUDE.md"
    else
        sed -i "s/PROFILE_NAME_PLACEHOLDER/$profile_name/g" "$profile_dir/CLAUDE.md"
    fi

    success_box "Profile '$profile_name' created"

    echo "  Location: $profile_dir"
    echo ""
    echo "  Next steps:"
    echo "    â€¢ dotclaude edit $profile_name"
    echo "    â€¢ dotclaude activate $profile_name"

    footer_tip "Edit the profile to add your guidelines"
}

cmd_edit() {
    local profile_name=""

    # Parse arguments and flags
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            -*)
                error_box "Unknown flag: $1"
                echo "  Usage: dotclaude edit [profile-name] [--verbose]"
                exit 1
                ;;
            *)
                profile_name="$1"
                shift
                ;;
        esac
    done

    debug "cmd_edit called"

    if [ -z "$profile_name" ]; then
        # Edit current profile
        if [ ! -f "$CLAUDE_DIR/.current-profile" ]; then
            error_box "No active profile to edit"
            echo "  Specify a profile: dotclaude edit <profile-name> [--verbose]"
            echo ""
            exit 1
        fi
        profile_name=$(cat "$CLAUDE_DIR/.current-profile")
        debug "Editing current profile: $profile_name"
    else
        debug "Editing specified profile: $profile_name"
    fi

    # Validate profile name
    if ! validate_profile_name "$profile_name"; then
        debug "Profile name validation failed"
        exit 1
    fi

    local profile_dir="$PROFILES_DIR/$profile_name"
    debug "Profile directory: $profile_dir"

    if [ ! -d "$profile_dir" ]; then
        error_box "Profile '$profile_name' not found"
        exit 1
    fi

    local editor="${EDITOR:-nano}"

    # Validate editor command exists
    if ! command -v "$editor" &> /dev/null; then
        error_box "Editor not found: $editor"
        echo "  Set EDITOR environment variable to a valid editor"
        exit 1
    fi

    "$editor" "$profile_dir/CLAUDE.md"
}

cmd_diff() {
    local profile1=""
    local profile2=""

    # Parse arguments and flags
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            -*)
                error_box "Unknown flag: $1"
                echo "  Usage: dotclaude diff <profile1> <profile2> [--verbose]"
                echo "     Or: dotclaude diff <profile> [--verbose]  (compare current vs profile)"
                exit 1
                ;;
            *)
                if [ -z "$profile1" ]; then
                    profile1="$1"
                elif [ -z "$profile2" ]; then
                    profile2="$1"
                fi
                shift
                ;;
        esac
    done

    debug "cmd_diff called"
    debug "Profile1: $profile1"
    debug "Profile2: $profile2"

    # If only one argument, compare current vs specified profile
    if [ -z "$profile2" ]; then
        if [ ! -f "$CLAUDE_DIR/.current-profile" ]; then
            error_box "No active profile to compare"
            echo "  Usage: dotclaude diff <profile1> <profile2> [--verbose]"
            echo "     Or: dotclaude diff <profile> [--verbose]  (compare current vs profile)"
            exit 1
        fi
        profile2="$profile1"
        profile1="$(cat "$CLAUDE_DIR/.current-profile")"
        debug "Comparing current ($profile1) vs specified ($profile2)"
    fi

    if [ -z "$profile1" ] || [ -z "$profile2" ]; then
        error_box "Two profiles required"
        echo "  Usage: dotclaude diff <profile1> <profile2> [--verbose]"
        echo "     Or: dotclaude diff <profile> [--verbose]  (compare current vs profile)"
        exit 1
    fi

    # Validate profile names
    if ! validate_profile_name "$profile1" || ! validate_profile_name "$profile2"; then
        exit 1
    fi

    local profile1_dir="$PROFILES_DIR/$profile1"
    local profile2_dir="$PROFILES_DIR/$profile2"

    if [ ! -d "$profile1_dir" ]; then
        error_box "Profile '$profile1' not found"
        exit 1
    fi

    if [ ! -d "$profile2_dir" ]; then
        error_box "Profile '$profile2' not found"
        exit 1
    fi

    header
    echo "  Comparing profiles: ${BOLD}$profile1${NC} vs ${BOLD}$profile2${NC}"
    echo ""

    # Compare CLAUDE.md files
    echo "  ${BOLD}CLAUDE.md differences:${NC}"
    echo ""

    if [ ! -f "$profile1_dir/CLAUDE.md" ]; then
        echo "    ${RED}âœ—${NC} $profile1: CLAUDE.md not found"
    elif [ ! -f "$profile2_dir/CLAUDE.md" ]; then
        echo "    ${RED}âœ—${NC} $profile2: CLAUDE.md not found"
    else
        # Use diff to show differences
        if diff -q "$profile1_dir/CLAUDE.md" "$profile2_dir/CLAUDE.md" > /dev/null 2>&1; then
            echo "    ${GREEN}âœ“${NC} No differences"
        else
            echo "    ${YELLOW}Differences found:${NC}"
            echo ""
            # Show unified diff with context
            diff -u "$profile1_dir/CLAUDE.md" "$profile2_dir/CLAUDE.md" | tail -n +3 | head -n 50 | while IFS= read -r line; do
                if [[ "$line" =~ ^- ]]; then
                    echo "      ${RED}$line${NC}"
                elif [[ "$line" =~ ^\+ ]]; then
                    echo "      ${GREEN}$line${NC}"
                elif [[ "$line" =~ ^@ ]]; then
                    echo "      ${CYAN}$line${NC}"
                else
                    echo "      $line"
                fi
            done
            echo ""
            local total_diff_lines
            total_diff_lines=$(diff -u "$profile1_dir/CLAUDE.md" "$profile2_dir/CLAUDE.md" | wc -l)
            if [ "$total_diff_lines" -gt 53 ]; then
                echo "      ${YELLOW}... ($((total_diff_lines - 53)) more lines)${NC}"
                echo ""
                echo "    ${BLUE}Tip:${NC} See full diff with:"
                echo "      diff -u $profile1_dir/CLAUDE.md $profile2_dir/CLAUDE.md"
            fi
        fi
    fi

    # Compare settings.json files
    echo ""
    echo "  ${BOLD}settings.json:${NC}"
    echo ""

    local settings1="$profile1_dir/settings.json"
    local settings2="$profile2_dir/settings.json"

    # Use base if profile doesn't have settings
    if [ ! -f "$settings1" ]; then
        settings1="$BASE_DIR/settings.json"
        echo "    $profile1: using base settings"
    fi
    if [ ! -f "$settings2" ]; then
        settings2="$BASE_DIR/settings.json"
        echo "    $profile2: using base settings"
    fi

    if diff -q "$settings1" "$settings2" > /dev/null 2>&1; then
        echo "    ${GREEN}âœ“${NC} No differences"
    else
        echo "    ${YELLOW}Differences found${NC}"
        echo ""
        echo "    ${BLUE}Tip:${NC} See full diff with:"
        echo "      diff -u $settings1 $settings2"
    fi

    echo ""
    footer_tip "Use 'dotclaude activate <profile> --dry-run' to preview activation"
}

cmd_restore() {
    # Parse flags
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    debug "cmd_restore called"
    debug "Checking for backups in $CLAUDE_DIR"
    header
    echo "  ${BOLD}Backup Restoration${NC}"
    echo ""

    # Find all backups
    local -a claude_backups=()
    local -a settings_backups=()

    if compgen -G "$CLAUDE_DIR/CLAUDE.md.backup.*" > /dev/null; then
        while IFS= read -r backup; do
            claude_backups+=("$backup")
        done < <(ls -t "$CLAUDE_DIR"/CLAUDE.md.backup.* 2>/dev/null)
    fi

    if compgen -G "$CLAUDE_DIR/settings.json.backup.*" > /dev/null; then
        while IFS= read -r backup; do
            settings_backups+=("$backup")
        done < <(ls -t "$CLAUDE_DIR"/settings.json.backup.* 2>/dev/null)
    fi

    if [ ${#claude_backups[@]} -eq 0 ] && [ ${#settings_backups[@]} -eq 0 ]; then
        echo "  ${YELLOW}No backups found${NC}"
        echo ""
        echo "  Backups are created automatically when switching profiles."
        echo ""
        footer_tip "Use 'dotclaude activate' to switch profiles"
        return 0
    fi

    echo "  ${BOLD}Available backups:${NC}"
    echo ""

    local -a all_backups=()
    local index=1

    # List CLAUDE.md backups
    if [ ${#claude_backups[@]} -gt 0 ]; then
        echo "  ${CYAN}CLAUDE.md backups:${NC}"
        for backup in "${claude_backups[@]}"; do
            local basename
            basename=$(basename "$backup")
            local timestamp
            timestamp="${basename#CLAUDE.md.backup.}"
            local size
            size=$(du -h "$backup" | cut -f1)
            echo "    [$index] $timestamp ($size)"
            all_backups+=("$backup")
            index=$((index + 1))
        done
        echo ""
    fi

    # List settings.json backups
    if [ ${#settings_backups[@]} -gt 0 ]; then
        echo "  ${CYAN}settings.json backups:${NC}"
        for backup in "${settings_backups[@]}"; do
            local basename
            basename=$(basename "$backup")
            local timestamp
            timestamp="${basename#settings.json.backup.}"
            local size
            size=$(du -h "$backup" | cut -f1)
            echo "    [$index] $timestamp ($size)"
            all_backups+=("$backup")
            index=$((index + 1))
        done
        echo ""
    fi

    read -r -p "  Select backup to restore (or 'q' to quit): " choice

    if [ "$choice" = "q" ] || [ "$choice" = "Q" ]; then
        echo ""
        echo "  Cancelled"
        echo ""
        return 0
    fi

    if ! [[ "$choice" =~ ^[0-9]+$ ]] || [ "$choice" -lt 1 ] || [ "$choice" -gt "${#all_backups[@]}" ]; then
        error_box "Invalid selection"
        exit 1
    fi

    local selected_backup="${all_backups[$((choice - 1))]}"
    local basename
    basename=$(basename "$selected_backup")
    local target_file=""

    if [[ "$basename" =~ ^CLAUDE.md.backup ]]; then
        target_file="$CLAUDE_DIR/CLAUDE.md"
    else
        target_file="$CLAUDE_DIR/settings.json"
    fi

    echo ""
    echo "  ${YELLOW}âš   This will overwrite:${NC}"
    echo "    $target_file"
    echo ""
    read -p "  Continue? (y/N): " -n 1 -r
    echo ""

    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        echo ""
        echo "  Cancelled"
        echo ""
        return 0
    fi

    # Create backup of current file before restoring
    local current_backup
    current_backup="${target_file}.backup.$(date +%Y%m%d-%H%M%S)"
    if [ -f "$target_file" ]; then
        cp "$target_file" "$current_backup"
        chmod 600 "$current_backup" 2>/dev/null || true
        echo ""
        echo "  ${BLUE}[BACKUP]${NC} Current file backed up to:"
        echo "    $(basename "$current_backup")"
    fi

    # Restore the selected backup
    cp "$selected_backup" "$target_file"
    echo "  ${GREEN}[RESTORE]${NC} Restored from: $(basename "$selected_backup")"

    # Update .current-profile marker if we can detect it
    if [[ "$basename" =~ ^CLAUDE.md.backup ]]; then
        # Try to detect profile from CLAUDE.md content
        local detected_profile
        detected_profile=$(grep -oP '# Profile: \K[^\s]+' "$target_file" | head -1)
        if [ -n "$detected_profile" ]; then
            echo "$detected_profile" > "$CLAUDE_DIR/.current-profile"
            echo "  ${GREEN}[UPDATE]${NC} Active profile: $detected_profile"
        fi
    fi

    echo ""
    success_box "Backup restored successfully"

    echo "  Restored: $target_file"
    echo ""
    footer_tip "Verify with 'dotclaude show'"
}

cmd_help() {
    local command="$1"

    if [ -z "$command" ]; then
        header

        echo "  ${BOLD}The definitive profile management system for Claude Code${NC}"
        echo ""
        echo "  ${BOLD}USAGE${NC}"
        echo "    dotclaude <command> [options]"
        echo ""
        echo "  ${BOLD}CORE COMMANDS${NC}"
        echo "    ${GREEN}show${NC} [--verbose]             Show current active profile"
        echo "    ${GREEN}list${NC} [--verbose]             List all available profiles"
        echo "    ${GREEN}activate${NC} <name> [--dry-run] [--verbose]"
        echo "                              Activate a profile"
        echo "    ${GREEN}switch${NC} [--verbose]           Interactive profile switcher"
        echo "    ${GREEN}diff${NC} <p1> [p2] [--verbose]   Compare profiles"
        echo ""
        echo "  ${BOLD}PROFILE MANAGEMENT${NC}"
        echo "    ${GREEN}create${NC} <name> [--verbose]    Create a new profile"
        echo "    ${GREEN}edit${NC} [name] [--verbose]      Edit profile (current if not specified)"
        echo "    ${GREEN}restore${NC} [--verbose]          Restore from backup interactively"
        echo ""
        echo "  ${BOLD}GIT WORKFLOW${NC}"
        echo "    ${GREEN}sync${NC} [--verbose]             Sync feature branch with main"
        echo "    ${GREEN}branches${NC} [--verbose]         Check branch status"
        echo ""
        echo "  ${BOLD}SYSTEM${NC}"
        echo "    ${GREEN}version${NC}                      Show version"
        echo "    ${GREEN}help${NC} [command]               Show help"
        echo ""
        echo "  ${BOLD}DEBUG${NC}"
        echo "    Add ${GREEN}--verbose${NC} to any command for detailed debug output"
        echo "    Or set ${GREEN}DEBUG=1${NC} environment variable"
        echo "    Debug log: ${GREEN}~/.claude/.dotclaude-debug.log${NC}"
        echo ""

        footer_tip "Run 'dotclaude help <command>' for detailed help"
        exit 0
    fi

    # Command-specific help
    case "$command" in
        show|list|activate|switch|create|edit)
            echo "Help for '$command' coming soon..."
            ;;
        *)
            error_box "Unknown command: $command"
            ;;
    esac
}

cmd_version() {
    header
    echo "  ${BOLD}dotclaude${NC} version ${GREEN}$VERSION${NC}"
    echo ""
    echo "  The definitive profile management system for Claude Code"
    echo ""
    echo "  Repository: $REPO_DIR"
    echo "  Configuration: $CLAUDE_DIR"
    echo ""
}

cmd_sync() {
    # Parse flags
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    debug "cmd_sync called"
    debug "Sync script: $BASE_DIR/scripts/sync-feature-branch.sh"

    if [ -f "$BASE_DIR/scripts/sync-feature-branch.sh" ]; then
        export DEBUG  # Pass debug mode to child script
        bash "$BASE_DIR/scripts/sync-feature-branch.sh"
    else
        error_box "Git sync tool not found"
        exit 1
    fi
}

cmd_branches() {
    # Parse flags
    while [ $# -gt 0 ]; do
        case "$1" in
            --verbose|--debug)
                DEBUG=1
                debug "Debug mode enabled"
                shift
                ;;
            *)
                shift
                ;;
        esac
    done

    debug "cmd_branches called"
    debug "Shell functions: $BASE_DIR/scripts/shell-functions.sh"

    if [ -f "$BASE_DIR/scripts/shell-functions.sh" ]; then
        export DEBUG  # Pass debug mode to sourced functions
        source "$BASE_DIR/scripts/shell-functions.sh"
        check-branches
    else
        error_box "Branch check tool not found"
        exit 1
    fi
}

# ============================================================================
# Main Dispatcher
# ============================================================================

main() {
    local command="${1:-help}"
    shift || true

    case "$command" in
        show)
            cmd_show "$@"
            ;;
        list|ls)
            cmd_list "$@"
            ;;
        activate|use)
            cmd_activate "$@"
            ;;
        switch|select)
            cmd_switch "$@"
            ;;
        create|new)
            cmd_create "$@"
            ;;
        edit)
            cmd_edit "$@"
            ;;
        diff)
            cmd_diff "$@"
            ;;
        restore)
            cmd_restore "$@"
            ;;
        sync)
            cmd_sync "$@"
            ;;
        branches|br)
            cmd_branches "$@"
            ;;
        version|-v|--version)
            cmd_version "$@"
            ;;
        help|-h|--help)
            cmd_help "$@"
            ;;
        *)
            error_box "Unknown command: $command"
            echo "  Run 'dotclaude help' for usage information"
            echo ""
            exit 1
            ;;
    esac
}

main "$@"
