#!/bin/bash
# dotclaude wrapper - routes to Go or shell implementation
# Part of the strangler fig migration strategy

set -e

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_DIR="$(cd "$SCRIPT_DIR/../.." && pwd)"
GO_BINARY="$REPO_DIR/bin/dotclaude-go"
SHELL_BINARY="$SCRIPT_DIR/dotclaude-shell"

# Allow manual override: DOTCLAUDE_BACKEND=go|shell|auto
BACKEND="${DOTCLAUDE_BACKEND:-auto}"

case "$BACKEND" in
    go)
        # Force Go implementation
        if [ ! -x "$GO_BINARY" ]; then
            echo "Error: Go binary not found at $GO_BINARY" >&2
            echo "Run: make build" >&2
            exit 1
        fi
        exec "$GO_BINARY" "$@"
        ;;
    shell)
        # Force shell implementation
        exec "$SHELL_BINARY" "$@"
        ;;
    auto)
        # Smart routing: Try Go first, fall back to shell if not implemented
        if [ -x "$GO_BINARY" ]; then
            "$GO_BINARY" "$@" 2>&1
            exit_code=$?

            # Exit code 127 means "command not implemented" in Go
            # Fall back to shell for unimplemented commands
            if [ $exit_code -eq 127 ]; then
                exec "$SHELL_BINARY" "$@"
            fi

            exit $exit_code
        else
            # Go binary not built yet, use shell
            exec "$SHELL_BINARY" "$@"
        fi
        ;;
    *)
        echo "Error: Unknown DOTCLAUDE_BACKEND=$BACKEND" >&2
        echo "Valid options: go, shell, auto" >&2
        exit 1
        ;;
esac
